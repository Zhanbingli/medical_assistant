import re
import os

# ================= é…ç½®åŒºåŸŸ =================
# è¾“å…¥æ–‡ä»¶ (åˆšæ‰è½¬æ¢å‡ºæ¥çš„é‚£ä¸ª)
INPUT_FILE = "è¯Šæ–­å­¦_cleaned.md"
# è¾“å‡ºæ–‡ä»¶ (æ¸…æ´—åŽçš„æœ€ç»ˆæˆå“)
OUTPUT_FILE = "è¯Šæ–­å­¦_final.md"

# ä½ æƒ³ä»Žæ–‡ä¸­åˆ æŽ‰çš„ç‰¹å®šå…³é”®è¯ (æ¯”å¦‚ä¹¦åã€ç« èŠ‚åå‡ºçŽ°åœ¨é¡µçœ‰çš„)
# è¿™é‡Œçš„å…³é”®è¯æ”¯æŒæ­£åˆ™ï¼Œæ¯”å¦‚ "è¯Šæ–­å­¦.*ç¬¬.*ç‰ˆ"
REMOVE_KEYWORDS = [
    "è¯Šæ–­å­¦",
    "ç¬¬.ç¯‡",  # åŒ¹é…å¦‚ "ç¬¬ä¸€ç¯‡"
    "ç¬¬.ç« ",  # åŒ¹é…å¦‚ "ç¬¬ä¸€ç« "
    "Page",   # åŒ¹é… "Page 12" è¿™ç§
]
# ===========================================

def clean_markdown(text):
    print("ðŸ§¹ æ­£åœ¨è¿›è¡Œæ·±åº¦æ¸…æ´—...")

    # 1. ã€æ ¸å¿ƒã€‘åŽ»é™¤é¡µç  (å•ç‹¬ä¸€è¡Œçš„æ•°å­—)
    # åŒ¹é…è§„åˆ™ï¼šè¡Œé¦–-å¯é€‰ç©ºæ ¼-æ•°å­—-å¯é€‰ç©ºæ ¼-è¡Œå°¾
    text = re.sub(r'^\s*\d+\s*$', '', text, flags=re.MULTILINE)

    # 2. ã€æ ¸å¿ƒã€‘åŽ»é™¤é¡µçœ‰/é¡µè„š (åŒ…å«ç‰¹å®šå…³é”®è¯çš„è¡Œ)
    for keyword in REMOVE_KEYWORDS:
        # (?i) å¿½ç•¥å¤§å°å†™
        pattern = fr'^.*{keyword}.*$'
        text = re.sub(pattern, '', text, flags=re.MULTILINE | re.IGNORECASE)

    # 3. ã€è§†è§‰ã€‘åŽ»é™¤ Markdown å›¾ç‰‡å ä½ç¬¦
    # åŒ¹é…è§„åˆ™ï¼š![ä»»æ„æ–‡å­—](ä»»æ„é“¾æŽ¥)
    text = re.sub(r'!\[.*?\]\(.*?\)', '', text)

    # 4. ã€ç»“æž„ã€‘ä¿®å¤æ–­è£‚çš„æ®µè½ (ä¸­æ–‡è¯­å¢ƒä¸‹éžå¸¸é‡è¦ï¼)
    # é€»è¾‘ï¼šå¦‚æžœä¸€è¡Œä»¥ä¸­æ–‡ç»“å°¾ï¼ˆéžæ ‡ç‚¹ï¼‰ï¼Œä¸‹ä¸€è¡Œä»¥ä¸­æ–‡å¼€å¤´ï¼Œè¯´æ˜Žè¢«å¼ºåˆ¶æ¢è¡Œäº†ï¼Œéœ€è¦åˆå¹¶ã€‚
    # [^ã€‚ï¼ï¼Ÿï¼šï¼›\n] è¡¨ç¤ºä¸æ˜¯å¥å·æ„Ÿå¹å·ç­‰ç»“å°¾
    # \n æ¢è¡Œç¬¦
    # \s* è¿™é‡Œçš„ç©ºæ ¼
    # (?=[^\s]) é¢„æŸ¥ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸æ˜¯ç©ºæ ¼
    print("ðŸ”— æ­£åœ¨ä¿®å¤æ–­è£‚çš„æ®µè½...")
    pattern_merge = r'([\u4e00-\u9fa5][^ã€‚ï¼ï¼Ÿï¼šï¼›\n])\n\s*(?=[\u4e00-\u9fa5])'
    text = re.sub(pattern_merge, r'\1', text)

    # 5. ã€ç»†èŠ‚ã€‘åŽ»é™¤å¤šä½™çš„ç©ºè¡Œ (è¶…è¿‡2ä¸ªç©ºè¡Œå˜æˆ2ä¸ª)
    text = re.sub(r'\n{3,}', '\n\n', text)

    return text

def main():
    if not os.path.exists(INPUT_FILE):
        print(f"âŒ æ‰¾ä¸åˆ°æ–‡ä»¶: {INPUT_FILE}")
        return

    with open(INPUT_FILE, 'r', encoding='utf-8') as f:
        content = f.read()

    # æ‰§è¡Œæ¸…æ´—
    cleaned_content = clean_markdown(content)

    with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
        f.write(cleaned_content)

    print(f"âœ… æ¸…æ´—å®Œæˆï¼")
    print(f"ðŸ“„ è¾“å‡ºæ–‡ä»¶: {os.path.abspath(OUTPUT_FILE)}")
    print(f"ðŸ“‰ ä½“ç§¯å˜åŒ–: {len(content)} å­—ç¬¦ -> {len(cleaned_content)} å­—ç¬¦")

if __name__ == "__main__":
    main()
